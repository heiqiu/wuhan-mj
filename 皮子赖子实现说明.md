# 武汉麻将"前皮后赖"规则实现说明

## 📋 规则理解

### 前皮后赖规则
- **翻指示牌**: 随机翻一张牌作为"皮子指示牌"（如8万）
- **皮子（前皮）**: 
  - 剩余的该牌（3张8万）
  - 前一张牌的所有4张（4张7万）
  - **红中永远是皮子**
  - 共计：**4张前皮 + 3张同皮 + 红中 = 最多8张皮子**
  
- **赖子（后赖）**: 
  - 后一张牌的所有4张（4张9万）
  - 共计：**4张赖子**

### 特殊规则
- **皮子**: 可当万能牌，但持有不能胡牌，可以杠（黑的1番）
- **赖子**: 可当万能牌，软胡×1，硬胡×2，可杠（2番）
- **两赖子**: 不能胡小胡
- **红中**: 功能与皮子相同，可随时杠（1番）

## ✅ 已实现功能

### 1. MajiangRules.js - 规则引擎增强

#### 新增方法
```javascript
// 根据指示牌计算皮子和赖子
static calculatePiziLaizi(indicatorTile) {
  // 返回: { indicatorTile, piziTiles: [], laiziTiles: [] }
  // piziTiles包括: 红中 + 指示牌 + 前一张牌
  // laiziTiles包括: 后一张牌
}

// 判断是否为皮子
static isPizi(tile, piziTiles)

// 判断是否为赖子
static isLaizi(tile, laiziTiles)

// 统计皮子数量
static countPizi(hand, piziTiles)

// 统计赖子数量（已更新为数组参数）
static countLaizi(hand, laiziTiles)
```

#### 规则配置
```javascript
PIZI_RULES: {
  IS_WILDCARD: true,        // 可以当任意牌使用
  CAN_GANG: true,           // 可以杠牌
  HOLD_CANNOT_HU: true,     // 持有皮子不能胡牌
  GANG_FANSHU: 1,           // 皮子杠1番（黑的）
  COUNT_CALCULATION: {      // 皮子数量计算
    indicator: 0,           // 翻出的指示牌不在手牌中
    same: 3,                // 剩余3张同牌是皮子
    previous: 4             // 前一张的4张是皮子
  }
}
```

### 2. TileGenerator.js - 新增翻指示牌功能

```javascript
/**
 * 翻指示牌(用于确定皮子和赖子)
 * @param {Array} excludeTiles - 已经发出的牌（包括庄家和闲家手牌）
 */
drawIndicatorTile(excludeTiles = []) {
  return this.drawTile(excludeTiles);
}
```

### 3. TileAnalyzer.js - 全面重构

#### 更新所有方法签名
```javascript
// 构造函数
constructor(piziTiles = null, laiziTiles = null)

// 核心方法
findBestDiscard(hand, gameContext)  // gameContext包含 piziTiles, laiziTiles
evaluateDiscardValue(tile, hand, piziTiles, laiziTiles, hasOpened)
isIsolatedTile(tile, hand, piziTiles, laiziTiles)
calculatePartialPotential(tile, hand, piziTiles, laiziTiles)
checkSequencePotential(tile, hand, piziTiles, laiziTiles)
explainDiscard(tile, hand, piziTiles, laiziTiles)
checkGameRules(hand, piziTiles, laiziTiles, hasOpened)
evaluateHandQuality(hand, piziTiles, laiziTiles)
```

#### 打牌优先级规则
```javascript
1. 红中 → -1000分（最高优先级，持有不能胡）
2. 皮子 → -1000分（与红中相同优先级，持有不能胡）
3. 多余赖子 → -800分（两个赖子不能胡小胡）
4. 单个赖子 → 根据手牌质量评估（±100分）
5. 孤张 → -50分
6. 边张 → -20分
7. 字牌单张 → -30分
```

### 4. GameState.js - 状态管理增强

```javascript
// 新增状态字段
currentRound: {
  indicatorTile: null,  // 翻出的指示牌
  piziTiles: [],        // 皮子列表
  laiziTiles: []        // 赖子列表
}

// startNewRound() - 自动翻牌
const indicatorTile = this.generator.drawIndicatorTile(allTiles);
const piziLaiziInfo = MajiangRules.calculatePiziLaizi(indicatorTile);

// analyzeRound() - 传递上下文
const gameContext = {
  hasOpened: round.hasOpened,
  piziTiles: round.piziTiles,
  laiziTiles: round.laiziTiles
};
```

## 📊 规则检查示例

系统会实时显示：
- ⚠️ **红中规则(皮子)**: 手牌中有红中(皮子)，必须打出
- ⚠️ **皮子规则**: 手牌中有2张皮子(七万、八万)，必须打出
- ⚠️ **赖子规则**: 手牌中有2张赖子，不能胡小胡，建议打掉一张
- ℹ️ **赖子规则**: 有一张赖子可作万能牌(软胡×1)，或硬胡(×2)
- ℹ️ **开口规则**: 尚未开口，需要吃、碰或杠才能胡牌

## 🎮 游戏流程

### 1. 开始新局
```javascript
startNewRound() {
  // 1. 发13张牌
  const initialHand = this.generator.generateHand();
  
  // 2. 摸一张牌
  const drawnTile = this.generator.drawTile(initialHand);
  
  // 3. 翻指示牌（从剩余牌堆）
  const allTiles = [...initialHand, drawnTile];
  const indicatorTile = this.generator.drawIndicatorTile(allTiles);
  
  // 4. 计算皮子和赖子
  const piziLaiziInfo = MajiangRules.calculatePiziLaizi(indicatorTile);
  // 结果: { 
  //   indicatorTile: 'wan8',
  //   piziTiles: ['zhong', 'wan8', 'wan7'],  // 红中+指示牌+前一张
  //   laiziTiles: ['wan9']                     // 后一张
  // }
}
```

### 2. 计算示例

#### 示例1: 翻出8万
- **指示牌**: 8万
- **皮子**: 红中、剩余3张8万、4张7万 = **8张**
- **赖子**: 4张9万

#### 示例2: 翻出1万
- **指示牌**: 1万
- **皮子**: 红中、剩余3张1万、4张9万（循环） = **8张**
- **赖子**: 4张2万

#### 示例3: 翻出9万
- **指示牌**: 9万
- **皮子**: 红中、剩余3张9万、4张8万 = **8张**
- **赖子**: 4张1万（循环）

#### 示例4: 翻出东风
- **指示牌**: 东风
- **皮子**: 红中、剩余3张东风、4张白板（循环） = **8张**
- **赖子**: 4张南风

## 🔧 待实现UI功能

### 1. 显示指示牌信息
需要在index.html中添加：
```html
<div id="indicator-info" class="indicator-info">
  <div>🎴 指示牌: <span id="indicator-tile-text">八万</span></div>
  <div>🟥 皮子: <span id="pizi-tiles-text">红中、七万、八万</span></div>
  <div>🟦 赖子: <span id="laizi-tiles-text">九万</span></div>
</div>
```

### 2. 更新app.js显示逻辑
```javascript
onStateChange(state) {
  const { currentRound } = state;
  
  // 显示指示牌信息
  if (currentRound.indicatorTile) {
    document.getElementById('indicator-tile-text').textContent = 
      TileUtils.getTileText(currentRound.indicatorTile);
    
    const piziText = currentRound.piziTiles
      .map(t => TileUtils.getTileText(t))
      .join('、');
    document.getElementById('pizi-tiles-text').textContent = piziText;
    
    const laiziText = currentRound.laiziTiles
      .map(t => TileUtils.getTileText(t))
      .join('、');
    document.getElementById('laizi-tiles-text').textContent = laiziText;
    
    document.getElementById('indicator-info').classList.remove('hidden');
  }
}
```

## ✨ 关键改进点

### 1. 规则准确性
- ✅ 完整实现"前皮后赖"规则
- ✅ 红中永远是皮子
- ✅ 循环处理边界情况（1/9、东南西北中发白）
- ✅ 皮子和赖子分别管理

### 2. 评估算法
- ✅ 皮子与红中同等优先级（-1000分）
- ✅ 持有皮子/红中不能胡牌
- ✅ 赖子根据数量和手牌质量智能评估
- ✅ 规则检查提示更详细

### 3. 代码架构
- ✅ 使用数组管理皮子和赖子（而非单张）
- ✅ 所有方法签名统一更新
- ✅ 规则引擎独立计算
- ✅ 状态管理清晰

## 📝 测试建议

### 测试场景1: 基础翻牌
1. 开始新轮，观察翻出的指示牌
2. 验证皮子列表（红中+指示牌+前一张）
3. 验证赖子列表（后一张）

### 测试场景2: 持有皮子
1. 如果手牌中有皮子，系统应提示必须打出
2. 皮子应显示在"规则提示"中
3. 打牌建议应优先推荐打出皮子

### 测试场景3: 持有赖子
1. 一张赖子：提示可作万能牌或硬胡
2. 两张赖子：警告不能胡小胡，建议打掉一张

### 测试场景4: 边界情况
1. 翻1万：皮子包括9万，赖子是2万
2. 翻9万：皮子包括8万，赖子是1万
3. 翻东风：皮子包括白板，赖子是南风

## 🎯 下一步优化

1. **UI完善**: 添加指示牌显示区域
2. **视觉增强**: 用不同颜色标记皮子和赖子
3. **规则说明**: 添加"前皮后赖"规则的详细说明
4. **测试页面**: 创建专门的皮子赖子测试页面

## 📖 规则参考

武汉麻将"前皮后赖"规则是武汉地区流行的玩法，与红中赖子杠规则结合，形成独特的游戏体验。本系统严格按照真实规则实现，确保训练效果。

---

**实现日期**: 2026-01-10  
**版本**: v2.1 (皮子赖子完整实现)
