<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ç³»ç»Ÿæµ‹è¯• - æ­¦æ±‰éº»å°†æ‹†æ­è®­ç»ƒ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-item {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .success { color: #27ae60; }
    .error { color: #e74c3c; }
    h1 { color: #2c5f2d; }
  </style>
</head>
<body>
  <h1>ğŸ”§ ç³»ç»Ÿæµ‹è¯•é¡µé¢</h1>
  <div id="test-results"></div>

  <!-- åŠ è½½æ‰€æœ‰JSæ–‡ä»¶ -->
  <script src="js/core/TileConstants.js"></script>
  <script src="js/core/TileUtils.js"></script>
  <script src="js/core/TileGenerator.js"></script>
  <script src="js/core/TileAnalyzer.js"></script>
  <script src="js/core/ScoringSystem.js"></script>
  <script src="js/state/GameState.js"></script>
  <script src="js/ui/TileDisplay.js"></script>
  <script src="js/ui/AnalysisPanel.js"></script>
  <script src="js/ui/HistoryPanel.js"></script>
  <script src="js/storage/StorageManager.js"></script>

  <script>
    const results = document.getElementById('test-results');
    
    function addTest(name, passed, message = '') {
      const div = document.createElement('div');
      div.className = 'test-item';
      div.innerHTML = `
        <strong>${passed ? 'âœ…' : 'âŒ'}</strong>
        <span class="${passed ? 'success' : 'error'}">${name}</span>
        ${message ? `<br><small>${message}</small>` : ''}
      `;
      results.appendChild(div);
    }

    // æµ‹è¯•1: å¸¸é‡å®šä¹‰
    try {
      addTest('TileConstants åŠ è½½', 
        TileConstants && TileConstants.ALL_TILES.length === 34,
        `ç‰Œå‹æ•°é‡: ${TileConstants.ALL_TILES.length}`
      );
    } catch (e) {
      addTest('TileConstants åŠ è½½', false, e.message);
    }

    // æµ‹è¯•2: å·¥å…·å‡½æ•°
    try {
      const parsed = TileUtils.parseTile('wan5');
      addTest('TileUtils.parseTile', 
        parsed.suit === 'wan' && parsed.number === 5,
        `è§£æç»“æœ: suit=${parsed.suit}, number=${parsed.number}`
      );
    } catch (e) {
      addTest('TileUtils.parseTile', false, e.message);
    }

    // æµ‹è¯•3: æ’åºåŠŸèƒ½
    try {
      const sorted = TileUtils.sortTiles(['wan3', 'wan1', 'wan2', 'dong']);
      addTest('TileUtils.sortTiles', 
        sorted[0] === 'wan1' && sorted[1] === 'wan2',
        `æ’åºç»“æœ: ${sorted.join(', ')}`
      );
    } catch (e) {
      addTest('TileUtils.sortTiles', false, e.message);
    }

    // æµ‹è¯•4: ç‰Œå‹ç”Ÿæˆ
    try {
      const generator = new TileGenerator();
      const hand = generator.generateHand({ difficulty: 'medium' });
      addTest('TileGenerator.generateHand', 
        hand.length === 13,
        `ç”Ÿæˆæ‰‹ç‰Œæ•°é‡: ${hand.length}, ç¤ºä¾‹: ${hand.slice(0, 5).join(', ')}...`
      );
    } catch (e) {
      addTest('TileGenerator.generateHand', false, e.message);
    }

    // æµ‹è¯•5: æ‘¸ç‰ŒåŠŸèƒ½
    try {
      const generator = new TileGenerator();
      const tile = generator.drawTile([]);
      addTest('TileGenerator.drawTile', 
        tile && typeof tile === 'string',
        `æ‘¸åˆ°çš„ç‰Œ: ${tile}`
      );
    } catch (e) {
      addTest('TileGenerator.drawTile', false, e.message);
    }

    // æµ‹è¯•6: ç‰Œå‹åˆ†æ
    try {
      const analyzer = new TileAnalyzer();
      const testHand = ['wan1','wan2','wan3','tong4','tong5','tong6','tiao7','tiao8','tiao9','dong','dong','nan','xi','bai'];
      const result = analyzer.findBestDiscard(testHand);
      addTest('TileAnalyzer.findBestDiscard', 
        result.bestDiscard !== null,
        `æœ€ä½³æ‰“ç‰Œ: ${result.bestDiscard}, åŸå› : ${result.reason}`
      );
    } catch (e) {
      addTest('TileAnalyzer.findBestDiscard', false, e.message);
    }

    // æµ‹è¯•7: è¯„åˆ†ç³»ç»Ÿ
    try {
      const scoring = new ScoringSystem();
      const mockSolution = {
        bestDiscard: 'wan1',
        score: -50,
        alternatives: [{tile: 'wan1', score: -50}, {tile: 'wan2', score: -30}],
        reason: 'æµ‹è¯•åŸå› '
      };
      const result = scoring.scoreChoice('wan1', mockSolution, mockSolution.alternatives);
      addTest('ScoringSystem.scoreChoice', 
        result.score === 100,
        `å¾—åˆ†: ${result.score}, åé¦ˆ: ${result.feedback}`
      );
    } catch (e) {
      addTest('ScoringSystem.scoreChoice', false, e.message);
    }

    // æµ‹è¯•8: æ¸¸æˆçŠ¶æ€ç®¡ç†
    try {
      const gameState = new GameState();
      gameState.startNewSession('medium');
      const state = gameState.getState();
      addTest('GameState.startNewSession', 
        state.session.sessionId !== null && state.currentRound.initialHand.length === 13,
        `ä¼šè¯ID: ${state.session.sessionId}, æ‰‹ç‰Œæ•°: ${state.currentRound.initialHand.length}`
      );
    } catch (e) {
      addTest('GameState.startNewSession', false, e.message);
    }

    // æµ‹è¯•9: å­˜å‚¨ç®¡ç†
    try {
      const storage = new StorageManager();
      const mockSession = {
        sessionId: 'test_123',
        rounds: [],
        totalScore: 0
      };
      const saved = storage.saveSession(mockSession);
      const loaded = storage.loadSessions();
      addTest('StorageManager è¯»å†™', 
        saved && loaded.length > 0,
        `ä¿å­˜æˆåŠŸ: ${saved}, åŠ è½½ä¼šè¯æ•°: ${loaded.length}`
      );
      // æ¸…ç†æµ‹è¯•æ•°æ®
      storage.clearAll();
    } catch (e) {
      addTest('StorageManager è¯»å†™', false, e.message);
    }

    // æµ‹è¯•10: ä¸­æ–‡æ˜¾ç¤º
    try {
      const text = TileUtils.getTileText('wan5');
      addTest('ä¸­æ–‡æ˜¾ç¤º', 
        text === '5ä¸‡',
        `ä¸‡5 æ˜¾ç¤ºä¸º: ${text}`
      );
    } catch (e) {
      addTest('ä¸­æ–‡æ˜¾ç¤º', false, e.message);
    }

    // æ·»åŠ æ€»ç»“
    setTimeout(() => {
      const summary = document.createElement('div');
      summary.className = 'test-item';
      summary.style.background = '#2c5f2d';
      summary.style.color = 'white';
      summary.innerHTML = `
        <h2>æµ‹è¯•å®Œæˆ!</h2>
        <p>âœ… å¦‚æœæ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡,è¯´æ˜ç³»ç»Ÿæ­£å¸¸</p>
        <p>ğŸ® ç°åœ¨å¯ä»¥æ‰“å¼€ <a href="index.html" style="color: #97ce4c">index.html</a> å¼€å§‹ä½¿ç”¨</p>
      `;
      results.appendChild(summary);
    }, 100);
  </script>
</body>
</html>
